"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3782],{7665:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>r,contentTitle:()=>c,default:()=>d,frontMatter:()=>i,metadata:()=>a,toc:()=>l});var t=s(74848),o=s(28453);const i={},c="Makefile reference",a={id:"container/components/k8s-cluster-api-provider/doc/make-reference",title:"Makefile reference",description:"This is a reference to the Makefile targets.",source:"@site/docs/03-container/components/k8s-cluster-api-provider/doc/make-reference.md",sourceDirName:"03-container/components/k8s-cluster-api-provider/doc",slug:"/container/components/k8s-cluster-api-provider/doc/make-reference",permalink:"/docs/container/components/k8s-cluster-api-provider/doc/make-reference",draft:!1,unlisted:!1,editUrl:"https://github.com/SovereignCloudStack/docs/tree/main/docs/03-container/components/k8s-cluster-api-provider/doc/make-reference.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Quickstart",permalink:"/docs/container/components/k8s-cluster-api-provider/doc/quickstart"},next:{title:"Application Credentials",permalink:"/docs/container/components/k8s-cluster-api-provider/doc/application-credentials"}},r={},l=[{value:"General commands",id:"general-commands",level:2},{value:"make create",id:"make-create",level:3},{value:"make get-kubeconfig",id:"make-get-kubeconfig",level:3},{value:"make ssh",id:"make-ssh",level:3},{value:"make openstack",id:"make-openstack",level:3},{value:"make k9s",id:"make-k9s",level:3},{value:"make log",id:"make-log",level:3},{value:"make console",id:"make-console",level:3},{value:"make deploy-cso",id:"make-deploy-cso",level:3},{value:"make deploy-cspo",id:"make-deploy-cspo",level:3},{value:"Teardown",id:"teardown",level:2},{value:"Make clean",id:"make-clean",level:3},{value:"Make fullclean",id:"make-fullclean",level:3},{value:"Make purge",id:"make-purge",level:3},{value:"Testing commands",id:"testing-commands",level:2},{value:"make check",id:"make-check",level:3},{value:"make check-quick",id:"make-check-quick",level:3},{value:"make check-conformance",id:"make-check-conformance",level:3},{value:"make check-storage",id:"make-check-storage",level:3},{value:"make check-csi",id:"make-check-csi",level:3},{value:"OpenTofu commands",id:"opentofu-commands",level:2},{value:"make init",id:"make-init",level:3},{value:"make attach",id:"make-attach",level:3},{value:"make detach",id:"make-detach",level:3},{value:"make state-push",id:"make-state-push",level:3},{value:"make dry-run",id:"make-dry-run",level:3},{value:"make show",id:"make-show",level:3},{value:"make list",id:"make-list",level:3}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",p:"p",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"makefile-reference",children:"Makefile reference"}),"\n",(0,t.jsx)(n.p,{children:"This is a reference to the Makefile targets."}),"\n",(0,t.jsxs)(n.p,{children:["Almost all targets require the ",(0,t.jsx)(n.code,{children:"ENVIRONMENT"})," variable to be set to the name of the environment you want to use.\n(See ",(0,t.jsx)(n.a,{href:"/docs/container/components/k8s-cluster-api-provider/doc/requirements#environments",children:"Environments"})," in the requirements documentation for more information.)"]}),"\n",(0,t.jsx)(n.h2,{id:"general-commands",children:"General commands"}),"\n",(0,t.jsx)(n.h3,{id:"make-create",children:"make create"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make create"})}),"\n",(0,t.jsx)(n.p,{children:"To initiate the management server setup, various components are created. This includes the provisioning of networks,\nsecurity groups, and a virtual machine. An application credential is also generated for authentication purposes. Once\nthe virtual machine is up and running, it is bootstrapped by cloning the specified git repository. Additionally,\nspecific tools are installed to facilitate the process."}),"\n",(0,t.jsxs)(n.p,{children:["Next, a local Kubernetes cluster is deployed using ",(0,t.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/kind",children:"kind"}),". The cluster acts as a foundation for further operations. During\nthe setup, the ",(0,t.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/cluster-api",children:"Cluster API"}),", as well as the Cluster API Provider (e.g. ",(0,t.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/cluster-api-provider-openstack",children:"CAPO"}),"), are installed within the local cluster. This provider serves as the API server for\nKubernetes CAPI, enabling management and interaction with the cloud backends (e.g. OpenStack)."]}),"\n",(0,t.jsx)(n.p,{children:"Finally, a test cluster is created utilizing Kubernetes CAPI. This test cluster allows for experimentation, validation,\nand development within the CAPI environment."}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["Note that ",(0,t.jsx)(n.code,{children:"make create"})," will not create a testcluster if you have set ",(0,t.jsx)(n.code,{children:"controller_count"})," to zero in your\nenvironment file (",(0,t.jsx)(n.code,{children:"environment-<yourcloud>.tfvars"}),")."]}),"\n"]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["Note that ",(0,t.jsx)(n.code,{children:"make create"})," does not copy local files to the management server, only some files are templated there from the ",(0,t.jsx)(n.code,{children:"terraform/files/template"})," directory. If you want to change any of the scripts\nbeing copied to the management server, you need to commit, push your changes, and run ",(0,t.jsx)(n.code,{children:"make create"})," again.\n",(0,t.jsx)(n.code,{children:"make create"})," will pull the latest changes from the git repository."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"make-get-kubeconfig",children:"make get-kubeconfig"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make get-kubeconfig"})}),"\n",(0,t.jsxs)(n.p,{children:["This will get the kubeconfig of the testcluster and store it in the file ",(0,t.jsx)(n.code,{children:"testcluster.yaml.<yourcloud>"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"make-ssh",children:"make ssh"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make ssh"})}),"\n",(0,t.jsxs)(n.p,{children:["This will ssh into the management server, using the username that was set in your ",(0,t.jsx)(n.code,{children:"environment-<yourcloud>.tfvars"}),"file. The default in the environment file is ",(0,t.jsx)(n.code,{children:"ubuntu"}),"."]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["Note: there is also an alias to this ",(0,t.jsx)(n.code,{children:"make login"})]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"make-openstack",children:"make openstack"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make openstack"})}),"\n",(0,t.jsx)(n.p,{children:"This will run openstack cli."}),"\n",(0,t.jsx)(n.h3,{id:"make-k9s",children:"make k9s"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make k9s"})}),"\n",(0,t.jsx)(n.p,{children:"This will run k9s on the management server."}),"\n",(0,t.jsx)(n.h3,{id:"make-log",children:"make log"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make log CONSOLE=capi-mgmtcluster"})}),"\n",(0,t.jsxs)(n.p,{children:["This will show openstack console log of the management server. You can specify the console log you want to see by\nsetting the ",(0,t.jsx)(n.code,{children:"CONSOLE"})," variable. The default is ",(0,t.jsx)(n.code,{children:"capi-mgmtcluster"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"make-console",children:"make console"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make console CONSOLE=capi-mgmtcluster"})}),"\n",(0,t.jsxs)(n.p,{children:["This will open openstack console of the management server in the browser using XDG-open. You can specify the console you\nwant to open by setting the ",(0,t.jsx)(n.code,{children:"CONSOLE"})," variable. The default is ",(0,t.jsx)(n.code,{children:"capi-mgmtcluster"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"make-deploy-cso",children:"make deploy-cso"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make deploy-cso"})}),"\n",(0,t.jsxs)(n.p,{children:["This will deploy the ",(0,t.jsx)(n.a,{href:"https://github.com/SovereignCloudStack/cluster-stack-operator",children:"cluster-stack-operator"}),". The preconfigured repo to look for cluster-stacks is ",(0,t.jsx)(n.a,{href:"https://github.com/SovereignCloudStack/cluster-stacks/",children:"https://github.com/SovereignCloudStack/cluster-stacks/"}),".\n",(0,t.jsx)(n.code,{children:"GIT_ACCESS_TOKEN"})," can be specified."]}),"\n",(0,t.jsx)(n.h3,{id:"make-deploy-cspo",children:"make deploy-cspo"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make deploy-cspo"})}),"\n",(0,t.jsxs)(n.p,{children:["This will deploy the ",(0,t.jsx)(n.a,{href:"https://github.com/SovereignCloudStack/cluster-stack-provider-openstack",children:"cluster-stack-provider-openstack"}),". The preconfigured repo to look for cluster-stacks is ",(0,t.jsx)(n.a,{href:"https://github.com/SovereignCloudStack/cluster-stacks/",children:"https://github.com/SovereignCloudStack/cluster-stacks/"}),".\n",(0,t.jsx)(n.code,{children:"GIT_ACCESS_TOKEN"})," can be specified."]}),"\n",(0,t.jsx)(n.h2,{id:"teardown",children:"Teardown"}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["Note that ",(0,t.jsx)(n.code,{children:"clean"})," and ",(0,t.jsx)(n.code,{children:"fullclean"})," leave the ",(0,t.jsx)(n.code,{children:"ubuntu-capi-image-$KUBERNETES_VERSION"})," image registered,\nso it can be reused.\nYou need to manually unregister it, if you want your next deployment to register a new image with\nthe same kubernetes version number."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"make-clean",children:"Make clean"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"make clean"})," does ssh to the capi management server to clean up the created clusters prior\nto opentofu cleaning up the resources it has created. This is sometimes insufficient to clean up\nunfortunately, some error in the deployment may result in resources left around."]}),"\n",(0,t.jsx)(n.h3,{id:"make-fullclean",children:"Make fullclean"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"make fullclean"})," uses a custom script ",(0,t.jsx)(n.code,{children:"cleanup/cleanup.sh"})," (using the openstack CLI) to clean up\neverything while trying to not hit any resources not created by the CAPI or opentofu for\nclusters from this management host.\nIt is the recommended way for doing cleanups if ",(0,t.jsx)(n.code,{children:"make clean"})," fails. Watch out for leftover\nfloating IP addresses and persistent volumes, as these can not be easily traced back to the\nCluster API created resources and may thus be left. There is also a ",(0,t.jsx)(n.code,{children:"make forceclean"})," variant\nthat hits unused floating IPs and all persistent volumes -- this is risky as there is no good\nway to tell which PVCs belong to us unless we find them attached to cluster nodes in which\ncase we don't need the force options."]}),"\n",(0,t.jsx)(n.h3,{id:"make-purge",children:"Make purge"}),"\n",(0,t.jsxs)(n.p,{children:["You can purge the whole project via ",(0,t.jsx)(n.code,{children:"make purge"}),". Be careful with that command as it will purge\n",(0,t.jsx)(n.em,{children:"all resources in the OpenStack project"})," even those that have not been created through this\nOpenTofu script or the Cluster API.\nIt requires the ",(0,t.jsx)(n.a,{href:"https://opendev.org/x/ospurge",children:(0,t.jsx)(n.code,{children:"ospurge"})})," tool.\nInstall it with ",(0,t.jsx)(n.code,{children:"python3 -m pip install git+https://git.openstack.org/openstack/ospurge"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"testing-commands",children:"Testing commands"}),"\n",(0,t.jsx)(n.h3,{id:"make-check",children:"make check"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make check SONOMODE=..."})}),"\n",(0,t.jsxs)(n.p,{children:["This will run tests of the configuration on testcluster using ",(0,t.jsx)(n.a,{href:"https://sonobuoy.io/",children:"sonobuoy"}),". It will also download the results and\nprint them to the console. Optionally you can also specify a mode by using for example ",(0,t.jsx)(n.code,{children:'SONOMODE="--mode quick"'})]}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:"Note: This runs over 5000 tests and takes a long time to complete (~ 2 hours)."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"make-check-quick",children:"make check-quick"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make check-quick"})}),"\n",(0,t.jsx)(n.p,{children:"This will run tests of the configuration on testcluster using sonobuoy with mode quick."}),"\n",(0,t.jsx)(n.h3,{id:"make-check-conformance",children:"make check-conformance"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make check-conformance"})}),"\n",(0,t.jsx)(n.p,{children:"This will run tests of the configuration on testcluster using sonobuoy with mode conformance meaning it will test if the\ncluster is conformant to the CNCF."}),"\n",(0,t.jsx)(n.h3,{id:"make-check-storage",children:"make check-storage"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make check-storage"})}),"\n",(0,t.jsx)(n.p,{children:"This will run tests of the configuration on testcluster using sonobuoy of the storage."}),"\n",(0,t.jsx)(n.h3,{id:"make-check-csi",children:"make check-csi"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make check-csi"})}),"\n",(0,t.jsx)(n.p,{children:"This will run tests of the configuration on testcluster using sonobuoy of the CSI."}),"\n",(0,t.jsx)(n.h2,{id:"opentofu-commands",children:"OpenTofu commands"}),"\n",(0,t.jsx)(n.h3,{id:"make-init",children:"make init"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make init"})}),"\n",(0,t.jsxs)(n.p,{children:["This will initialize opentofu. It will download the required providers and modules.\nIt will also select or create a new workspace for you. The workspace name is the same as the\n",(0,t.jsx)(n.code,{children:"ENVIROMENT"})," variable."]}),"\n",(0,t.jsx)(n.h3,{id:"make-attach",children:"make attach"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make attach RESOURCE=<resource-id> PARAMS=..."})}),"\n",(0,t.jsx)(n.p,{children:"This will attach a resource to the opentofu state. This is useful if you have created a resource outside of opentofu\nand want to manage it with opentofu."}),"\n",(0,t.jsx)(n.h3,{id:"make-detach",children:"make detach"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make detach RESOURCE=<resource-id> PARAMS=..."})}),"\n",(0,t.jsx)(n.p,{children:"This will detach a resource from the opentofu state. This is useful if you have changed a resource outside of opentofu\nor you no longer want to manage it with opentofu."}),"\n",(0,t.jsx)(n.h3,{id:"make-state-push",children:"make state-push"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make state-push"})}),"\n",(0,t.jsx)(n.p,{children:"This will push the opentofu state to specified storage if set. This is useful if you don't want to store the state\nlocally."}),"\n",(0,t.jsx)(n.h3,{id:"make-dry-run",children:"make dry-run"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make dry-run"})}),"\n",(0,t.jsx)(n.p,{children:"This will run a dry-run of the opentofu apply command. This is useful if you want to see what opentofu will do before\nactually doing it."}),"\n",(0,t.jsx)(n.h3,{id:"make-show",children:"make show"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make show"})}),"\n",(0,t.jsx)(n.p,{children:"This will show the opentofu state. This is useful if you want to see what opentofu is managing."}),"\n",(0,t.jsx)(n.h3,{id:"make-list",children:"make list"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"make list"})}),"\n",(0,t.jsx)(n.p,{children:"This will list all the resources managed by opentofu. This is useful if you want to see what opentofu is managing."})]})}function d(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>c,x:()=>a});var t=s(96540);const o={},i=t.createContext(o);function c(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:c(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);