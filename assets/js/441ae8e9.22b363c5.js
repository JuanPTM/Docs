"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2692],{32335:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>c,toc:()=>l});var s=t(74848),r=t(28453);const a={title:"Maintenance and Troubleshooting Guide for SCS k8s-cluster-api-provider",version:new Date("2023-03-16T00:00:00.000Z"),authors:"Kurt Garloff, Mathias Fechner, Andrej Friesen, Matej Feder",state:"Draft (v0.3)"},o="Maintenance and Troubleshooting Guide for SCS k8s-cluster-api-provider",c={id:"container/components/k8s-cluster-api-provider/doc/Maintenance_and_Troubleshooting",title:"Maintenance and Troubleshooting Guide for SCS k8s-cluster-api-provider",description:"Client Certificates in Kubernetes expire after one year",source:"@site/docs/03-container/components/k8s-cluster-api-provider/doc/Maintenance_and_Troubleshooting.md",sourceDirName:"03-container/components/k8s-cluster-api-provider/doc",slug:"/container/components/k8s-cluster-api-provider/doc/Maintenance_and_Troubleshooting",permalink:"/docs/container/components/k8s-cluster-api-provider/doc/Maintenance_and_Troubleshooting",draft:!1,unlisted:!1,editUrl:"https://github.com/SovereignCloudStack/docs/tree/main/docs/03-container/components/k8s-cluster-api-provider/doc/Maintenance_and_Troubleshooting.md",tags:[],version:"current",frontMatter:{title:"Maintenance and Troubleshooting Guide for SCS k8s-cluster-api-provider",version:"2023-03-16T00:00:00.000Z",authors:"Kurt Garloff, Mathias Fechner, Andrej Friesen, Matej Feder",state:"Draft (v0.3)"},sidebar:"docs",previous:{title:"Configuration",permalink:"/docs/container/components/k8s-cluster-api-provider/doc/configuration"},next:{title:"Ingress with externalTrafficPolicy: local",permalink:"/docs/container/components/k8s-cluster-api-provider/doc/LoadBalancer-ExtTrafficLocal"}},i={},l=[{value:"Client Certificates in Kubernetes expire after one year",id:"client-certificates-in-kubernetes-expire-after-one-year",level:2},{value:"Certificate Authority expires",id:"certificate-authority-expires",level:2},{value:"Failed cluster deployment debugging",id:"failed-cluster-deployment-debugging",level:2},{value:"Cluster state",id:"cluster-state",level:2},{value:"Etcd maintenance",id:"etcd-maintenance",level:2},{value:"Defragmentation and backup",id:"defragmentation-and-backup",level:3}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"maintenance-and-troubleshooting-guide-for-scs-k8s-cluster-api-provider",children:"Maintenance and Troubleshooting Guide for SCS k8s-cluster-api-provider"}),"\n",(0,s.jsx)(n.h2,{id:"client-certificates-in-kubernetes-expire-after-one-year",children:"Client Certificates in Kubernetes expire after one year"}),"\n",(0,s.jsxs)(n.p,{children:["What does a provider need to do in order to ",(0,s.jsx)(n.strong,{children:"NOT"})," run into a certificate issue?"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Update the cluster at least once a year to rotate certificates automatically"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#automatic-certificate-renewal",children:"Automatic certificate renewal for cluster upgrades"})}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["kubeadm renews all the certificates during control plane\n",(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/",children:"upgrade"}),".\nThis feature is designed for addressing the simplest use cases; if you don't have specific\nrequirements on certificate renewal and perform Kubernetes version upgrades regularly\n(less than 1 year in between each upgrade), kubeadm will take care of keeping your\ncluster up to date and reasonably secure."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Renew all certificates with ",(0,s.jsx)(n.code,{children:"kubeadm certs renew all"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"You only need to do this when you don't upgrade your cluster"}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-certs/#cmd-certs-renew",children:"kubeadm certs renew"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"certificate-authority-expires",children:"Certificate Authority expires"}),"\n",(0,s.jsx)(n.p,{children:"Another problem is that the CA might expire as well (normally after 10 years)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"kubeadm"})," does not have any tooling for this at the time of writing"]}),"\n",(0,s.jsxs)(n.li,{children:["There is documentation for\n",(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/tls/manual-rotation-of-ca-certificates/",children:"Manual Rotation of CA Certifcates"})]}),"\n",(0,s.jsxs)(n.li,{children:["On the management node, there is a ",(0,s.jsx)(n.code,{children:"signer.sh"})," that can be used to sign server certificates\nafter checking that they belong to the server."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"failed-cluster-deployment-debugging",children:"Failed cluster deployment debugging"}),"\n",(0,s.jsxs)(n.p,{children:["NOTE: The following ",(0,s.jsx)(n.code,{children:"kubectl"})," and ",(0,s.jsx)(n.code,{children:"clusterctl"})," commands should be executed against\nthe management Kubernetes cluster API. Keep in mind that these tools and the\n",(0,s.jsx)(n.code,{children:"kubeconfig"})," to access the management Kubernetes cluster are available in the management\nhost, hence it is convenient to execute the following commands from the management host."]}),"\n",(0,s.jsx)(n.p,{children:"Ask Kubernetes what went wrong:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl describe cluster <CLUSTER_NAME>\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The status and the events may give you a clue what happened. The healthy cluster should\nbe in the phase: ",(0,s.jsx)(n.code,{children:"Provisioned"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl describe cluster <CLUSTER_NAME> | yq .Status.Phase\nProvisioned\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can also have a look at the ",(0,s.jsx)(n.code,{children:"openstackcluster"})," object and see OpenStack related\nstatuses and events. The healthy cluster should be ready:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ kubectl describe openstackcluster <CLUSTER_NAME> | yq .Status.Ready\ntrue\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Note that you can instead execute ",(0,s.jsx)(n.code,{children:"kubectl get cluster <CLUSTER_NAME> -ojsonpath='{ .status.phase }'"}),"\nand ",(0,s.jsx)(n.code,{children:"kubectl get openstackcluster <CLUSTER_NAME> -ojsonpath='{ .status.ready }'"}),"\nif you don't have ",(0,s.jsx)(n.code,{children:"yq"})," at hand."]}),"\n",(0,s.jsxs)(n.p,{children:["A handy command for cluster health investigation is ",(0,s.jsx)(n.code,{children:"clusterctl describe cluster <CLUSTER_NAME>"}),".\nThis prints infrastructure/control plane/workers readiness status and other relevant\ninformation like a failure reason. The healthy cluster output is similar to this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ clusterctl describe cluster <CLUSTER_NAME>\nNAME                                                            READY  SEVERITY  REASON  SINCE  MESSAGE\nCluster/testcluster                                             True                     21m\n\u251c\u2500ClusterInfrastructure - OpenStackCluster/testcluster\n\u251c\u2500ControlPlane - KubeadmControlPlane/testcluster-control-plane  True                     23m\n\u2502 \u2514\u25003 Machines...                                               True                     21m    See testcluster-control-plane-5ftjs, testcluster-control-plane-62cdj, ...\n\n\u2514\u2500Workers\n  \u2514\u2500MachineDeployment/capi-testcluster-md-0-no1                 True                     22m\n    \u2514\u25003 Machines...                                             True                     21m    See capi-testcluster-md-0-no1-84dd86f598-bhxfd, capi-testcluster-md-0-no1-84dd86f598-f6pnl, ...\n"})}),"\n",(0,s.jsx)(n.p,{children:"The logs of the capi pod and especially the capo pod are a good source of information.\nTo find out in which condition the deployment status is, you can use the following way:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl logs -n capo-system -l control-plane=capo-controller-manager -c manager\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Successful cluster creation will log ",(0,s.jsx)(n.code,{children:"Reconciled Machine create successfully"})," for\nsuccessfully created nodes."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl logs -n capi-system -l control-plane=controller-manager -c manager\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In some cases could be a good idea to go through the official [capi]\n(",(0,s.jsx)(n.a,{href:"https://cluster-api.sigs.k8s.io/user/troubleshooting.html",children:"https://cluster-api.sigs.k8s.io/user/troubleshooting.html"}),") and ",(0,s.jsx)(n.a,{href:"https://cluster-api-openstack.sigs.k8s.io/topics/troubleshooting.html",children:"capo"}),"\ntroubleshooting guides or check whether you hit some known bug already reported in\n",(0,s.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/cluster-api/issues?q=is%3Aissue+is%3Aopen+label%3Akind%2Fbug",children:"capi"}),"\nor ",(0,s.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/cluster-api-provider-openstack/issues?q=is%3Aissue+is%3Aopen+label%3Akind%2Fbug",children:"capo"})," projects."]}),"\n",(0,s.jsx)(n.p,{children:"You can also check the OpenStack layer. A cluster deployment should result in a\nrouter,a network, a subnet, a loadbalancer (in front of kubeapi) and a number of servers (VMs)\nfor the control-plane and worker nodes. Have you run out of quota?"}),"\n",(0,s.jsx)(n.h2,{id:"cluster-state",children:"Cluster state"}),"\n",(0,s.jsxs)(n.p,{children:["Have a look at the pods that run:\n",(0,s.jsx)(n.code,{children:"kubectl --context=<CLUSTER_NAME>-admin@<CLUSTER_NAME> get pods -A"})]}),"\n",(0,s.jsxs)(n.p,{children:["or have a look at the nodes:\n",(0,s.jsx)(n.code,{children:"kubectl --context=<CLUSTER_NAME>-admin@<CLUSTER_NAME> get nodes -o wide"})]}),"\n",(0,s.jsxs)(n.p,{children:["If you fall into some Kubernetes specific issues after a successful cluster\ncreation, go through the official ",(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/debug/debug-cluster/",children:"Kubernetes"}),"\ntroubleshooting guide."]}),"\n",(0,s.jsx)(n.h2,{id:"etcd-maintenance",children:"Etcd maintenance"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://etcd.io/",children:"Etcd"})," is a highly-available key value store used as Kubernetes'\nbacking store for all cluster data. This section contains etcd related maintenance\nnotes from SCS k8s-cluster-api-provider project perspective."]}),"\n",(0,s.jsxs)(n.p,{children:["For further information about etcd maintenance visit an official ",(0,s.jsx)(n.a,{href:"https://etcd.io/docs/v3.5/op-guide/maintenance/",children:"etcd maintenance guide"}),"\nand/or ",(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/",children:"Kubernetes etcd operating guide"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"defragmentation-and-backup",children:"Defragmentation and backup"}),"\n",(0,s.jsxs)(n.p,{children:["Etcd storage can become fragmented over time, for this, we have included a\nmaintenance script that regularly defragments and then also backups the database.\nThe script, called ",(0,s.jsx)(n.code,{children:"etcd-defrag.sh"})," is located in each control plane node's  ",(0,s.jsx)(n.code,{children:"/root"}),"\ndirectory . It is executed through the systemd service unit file ",(0,s.jsx)(n.code,{children:"etcd-defrag.service"}),"\nand scheduled to run each day at 02:30:00 using the ",(0,s.jsx)(n.code,{children:"etcd-defrag.timer"})," systemd timer."]}),"\n",(0,s.jsxs)(n.p,{children:["The defragmentation strategy is inspired by the ",(0,s.jsx)(n.a,{href:"https://github.com/ugur99/etcd-defrag-cronjob/",children:"etcd-defrag-cronjob"})," and\n",(0,s.jsx)(n.a,{href:"https://docs.openshift.com/container-platform/4.9/scalability_and_performance/recommended-host-practices.html#automatic-defrag-etcd-data_recommended-host-practices",children:"practices recommended"})," by the OpenShift project.\nNote that the proposed strategy could be changed in a future version based on results from\nrelated ",(0,s.jsx)(n.a,{href:"https://github.com/etcd-io/etcd/issues/15477",children:"upstream issue #15477"})," which wants to define\nan official solution on how to defragment etcd cluster."]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"etcd-defrag.sh"})," script checks multiple conditions before the actual defragmentation as\nfollows:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The script should not be executed on non leader etcd member"}),"\n",(0,s.jsx)(n.li,{children:"The script should not be executed on etcd cluster with some unhealthy member"}),"\n",(0,s.jsx)(n.li,{children:"The script should not be executed on single member etcd cluster"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"These pre-flight checks should ensure, that the defragmentation does not cause temporary\netcd cluster failures and/or unwanted etcd leader changes. They also prevent executing\nthe script on a single control-plane node cluster. Single-node etcd clusters are not\nmade for long-term operation. As a workaround, however, you can scale up to three\ncontrol-plane nodes overnight from time to time."}),"\n",(0,s.jsx)(n.p,{children:"After all pre-flight checks passed the etcd cluster defragmentation is performed as follows:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Defragment the non leader etcd members first"}),"\n",(0,s.jsx)(n.li,{children:"Change the leadership to the randomly selected and defragmentation completed etcd member"}),"\n",(0,s.jsx)(n.li,{children:"Defragment the local (ex-leader) etcd member"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["At the end of the defragmentation script, the local (ex-leader) etcd member is backed up\nand trimmed. Backup is saved and then compressed in the control plane ",(0,s.jsx)(n.code,{children:"/root"})," directory.\nYou can find it here: ",(0,s.jsx)(n.code,{children:"/root/etcd-backup.xz"}),". File system trim is performed by the ",(0,s.jsx)(n.code,{children:"fstrim"}),"\ncommand that discards unused blocks on a filesystem which could increase write performance\non the long run and also release unused storage. Cluster admins are not supposed to log\nin to the cluster nodes (neither control plane nor workers) and thus won't access or use\nthese backup files. The local backups on these nodes however can prove useful however\nin a disaster recovery scenario."]}),"\n",(0,s.jsx)(n.p,{children:"All mentioned pre-flight checks could be skipped by the optional arguments that force\ndefragmentation despite potential failures. Optional arguments are:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--force-single"})," (allows to execute defragmentation on single member etcd cluster)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--force-unhealthy"})," (allows to execute defragmentation on unhealthy etcd member)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--force-nonleader"})," (allows to execute defragmentation on non leader etcd member)"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"We do not recommend to log in to the cluster nodes let alone executing manual\ndefragmentation"})," using the optional arguments above. If you are aware of potential\nissues, you can access the control plane node and execute the defragmentation script\nmanually as follows:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"/root/etcd-defrag.sh [--force-single] [--force-unhealthy] [--force-nonleader]\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var s=t(96540);const r={},a=s.createContext(r);function o(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);