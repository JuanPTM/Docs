"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[7653],{26093:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>a});var c=t(74848),s=t(28453);const o={},r="Custom CA",i={id:"container/components/k8s-cluster-api-provider/doc/usage/custom-ca",title:"Custom CA",description:"OpenStack provides public-facing API endpoints which protection by SSL/TLS certificates",source:"@site/docs/03-container/components/k8s-cluster-api-provider/doc/usage/custom-ca.md",sourceDirName:"03-container/components/k8s-cluster-api-provider/doc/usage",slug:"/container/components/k8s-cluster-api-provider/doc/usage/custom-ca",permalink:"/docs/container/components/k8s-cluster-api-provider/doc/usage/custom-ca",draft:!1,unlisted:!1,editUrl:"https://github.com/SovereignCloudStack/docs/tree/main/docs/03-container/components/k8s-cluster-api-provider/doc/usage/custom-ca.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Container registry configuration",permalink:"/docs/container/components/k8s-cluster-api-provider/doc/usage/containter-registry-configuration"},next:{title:"Gateway-API",permalink:"/docs/container/components/k8s-cluster-api-provider/doc/usage/gateway-api"}},d={},a=[{value:"Rotation",id:"rotation",level:2}];function l(e){const n={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.h1,{id:"custom-ca",children:"Custom CA"}),"\n",(0,c.jsx)(n.p,{children:"OpenStack provides public-facing API endpoints which protection by SSL/TLS certificates\nis highly recommended in production environments.\nThese certificates are usually issued by public CA but also the custom or private CA could be used."}),"\n",(0,c.jsxs)(n.p,{children:["If the communication with OpenStack API is protected by the certificate issued by custom CA\nthe ",(0,c.jsx)(n.code,{children:"cacert"})," setting needs to be provided inside clouds.yaml, e.g.:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-yaml",children:"clouds:\n  devstack:\n    cacert: ca-bundle.pem\n    auth:\n      auth_url: https://10.0.3.15/identity\n      project_domain_id: default\n      project_name: demo\n      user_domain_id: default\n    identity_api_version: 3\n    region_name: RegionOne\n    interface: public\n"})}),"\n",(0,c.jsxs)(n.p,{children:["Here the file ",(0,c.jsx)(n.code,{children:"ca-bundle.pem"})," contains custom root CA and potentially intermediate CA(s)."]}),"\n",(0,c.jsxs)(n.blockquote,{children:["\n",(0,c.jsxs)(n.p,{children:["The ",(0,c.jsx)(n.code,{children:"ca-bundle.pem"})," file will be copied to the management server and used by CAPO\nin the management cluster. Also, it will be copied to the workload cluster (control plane and worker nodes)\nand mounted and used by OCCM and CCSI pods.\nSo provide only the necessary certificates in that file."]}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"Steps of what happens with the custom cacert in k8s-cluster-api-provider:"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"cacert"})," setting is provided inside clouds.yaml"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsxs)(n.p,{children:["Cacert file referenced by ",(0,c.jsx)(n.code,{children:"cacert"})," key (1.) is copied to the management server\ndirectory ",(0,c.jsx)(n.code,{children:"~/cluster-defaults/${cloud_provider}-cacert"})," by OpenTofu"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsxs)(n.p,{children:["During the management server bootstrap process cacert is injected to\nthe ",(0,c.jsx)(n.code,{children:"~/cluster-defaults/cluster-template.yaml"})," to ",(0,c.jsx)(n.code,{children:"KubeadmControlPlane"})," and ",(0,c.jsx)(n.code,{children:"KubeadmConfigTemplate"})," files\nas file with cacert content from already defined secret ",(0,c.jsx)(n.code,{children:"${CLUSTER_NAME}-cloud-config"})," and will be later\ntemplated and copied to the workload cluster (control plane and worker nodes) provisioned by CAPO, e.g.:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-yaml",children:'files:\n- contentFrom:\n    secret:\n      key: cacert\n      name: ${CLUSTER_NAME}-cloud-config\n  owner: root:root\n  path: /etc/ssl/certs/devstack-cacert\n  permissions: "0644"\n'})}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsxs)(n.p,{children:["When the creation of the workload cluster (",(0,c.jsx)(n.code,{children:"create_cluster.sh"}),") starts,\n",(0,c.jsx)(n.code,{children:"~/cluster-defaults/cluster-template.yaml"})," is copied into workload cluster directory (",(0,c.jsx)(n.code,{children:"~/$CLUSTER_NAME/"}),")"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsxs)(n.p,{children:["Then the cacert file content is base64 encoded and saved in OPENSTACK_CLOUD_CACERT_B64 variable\ninside ",(0,c.jsx)(n.code,{children:"~/$CLUSTER_NAME/clusterctl.yaml"}),", so it can be used during\nthe workload cluster templating"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsxs)(n.p,{children:["Later, when the workload cluster templates are applied to the management cluster,\nsecret ",(0,c.jsx)(n.code,{children:"${CLUSTER_NAME}-cloud-config"})," with base64 encoded cacert is created and used by CAPO"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"CAPO will create workload cluster (thanks to steps 5. and 6.) and cacert is\ntransferred to the control plane and worker nodes (thanks to steps 3. and 4.)"}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"OCCM and CCSI pods mount cacert via hostPath volume\nand use it for e.g. creating load balancers or volumes"}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"rotation",children:"Rotation"}),"\n",(0,c.jsxs)(n.p,{children:["When the custom CA expires or otherwise changes it needs to be rotated.\nCAPO uses the custom CA certificate in the management cluster for creating the infrastructure\nfor the workload clusters and in the workload clusters by OCCM and CCSI for e.g. creating load balancers or volumes.\nIn both cases, cacert is provided via secret ",(0,c.jsx)(n.code,{children:"${CLUSTER_NAME}-cloud-config"})," and needs to be updated."]}),"\n",(0,c.jsx)(n.p,{children:"There are 3 steps in this rotation process:"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:["Replace/append custom CA certificate in ",(0,c.jsx)(n.code,{children:"~/cluster-defaults/${cloud_provider}-cacert"})]}),"\n",(0,c.jsxs)(n.li,{children:["Increase generation counters ",(0,c.jsx)(n.code,{children:"CONTROL_PLANE_MACHINE_GEN"})," and ",(0,c.jsx)(n.code,{children:"WORKER_MACHINE_GEN"})," in ",(0,c.jsx)(n.code,{children:"~/$CLUSTER_NAME/clusterctl.yaml"})]}),"\n",(0,c.jsxs)(n.li,{children:["Run ",(0,c.jsx)(n.code,{children:"create_cluster.sh $CLUSTER_NAME"})," and wait for the rolling update of your workload cluster"]}),"\n"]}),"\n",(0,c.jsxs)(n.blockquote,{children:["\n",(0,c.jsx)(n.p,{children:"In step 1, appending can be useful for avoiding downtime of your services.\nYour cacert file will contain two CA certificates - old and new.\nThis should help with a smooth transition to a new certificate and later, the old one can be removed."}),"\n",(0,c.jsx)(n.p,{children:"Steps 2 and 3 need to be done per workload cluster."}),"\n",(0,c.jsx)(n.p,{children:"When step 2 is omitted, only cacert secret in the management cluster is updated and no rolling update of\nthe workload cluster in step 3 is started and existing nodes remain with the old certificate."}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(l,{...e})}):l(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>i});var c=t(96540);const s={},o=c.createContext(s);function r(e){const n=c.useContext(o);return c.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),c.createElement(o.Provider,{value:n},e.children)}}}]);